<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>使用ElasticSearch搭建文章搜索引擎 | 技术随笔</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用ElasticSearch搭建文章搜索引擎</h1><a id="logo" href="/.">技术随笔</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用ElasticSearch搭建文章搜索引擎</h1><div class="post-meta">Jul 5, 2018<span> | </span><span class="category"><a href="/categories/foundation/">基础技术</a></span></div><div class="post-content"><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>环境 Ubuntu 16.04 </p>
<p>安装文档:<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="built_in">get</span> install openjdk-<span class="number">8</span>-jdk</span><br><span class="line"></span><br><span class="line">wget -qO - http<span class="variable">s:</span>//artifacts.elastic.<span class="keyword">co</span>/GPG-KEY-elasticsearch | apt-key <span class="built_in">add</span> -</span><br><span class="line">apt-<span class="built_in">get</span> install apt-transport-https</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"deb https://artifacts.elastic.co/packages/6.x/apt stable main"</span> |  tee -<span class="keyword">a</span> /etc/apt/sources.<span class="keyword">list</span>.d/elastic-<span class="number">6</span>.<span class="keyword">x</span>.<span class="keyword">list</span></span><br><span class="line"></span><br><span class="line">apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp;  apt-<span class="built_in">get</span> install elasticsearch</span><br></pre></td></tr></table></figure>
<p>修改配置文件 <code>/etc/elasticsearch/elasticsearch.yml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use a descriptive name <span class="keyword">for</span> your cluster:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set the <span class="built_in">bind</span> address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set a custom port <span class="keyword">for</span> HTTP:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><p>Running Elasticsearch with <code>systemdedit</code></p>
<p>To configure Elasticsearch to start automatically when the system boots up, run the following commands:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="builtin-name">enable</span> elasticsearch.service</span><br></pre></td></tr></table></figure>
<p>Elasticsearch can be started and stopped as follows:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start elasticsearch.service</span><br><span class="line">systemctl stop elasticsearch.service</span><br><span class="line">systemctl restart elasticsearch.service</span><br></pre></td></tr></table></figure>
<p>访问: <code>http://ip:9200/</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -<span class="selector-tag">i</span>:<span class="number">9200</span></span><br></pre></td></tr></table></figure>
<p>日志：<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">journalctl </span><span class="built_in">--unit</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">journalctl </span><span class="built_in">--unit</span> <span class="string">elasticsearch </span><span class="built_in">--since</span>  <span class="string">"2018-07-01 00:00:00"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="安装中文分词器"><a href="#安装中文分词器" class="headerlink" title="安装中文分词器"></a>安装中文分词器</h1><p><a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">IK中文分词器</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/29183128" target="_blank" rel="noopener">Elasticsearch 默认分词器和中分分词器之间的比较及使用方法</a></p>
<p> <a href="https://blog.csdn.net/chengyuqiang/article/details/78991570" target="_blank" rel="noopener">ElasticSearch 6.x 学习笔记：4.IK分词器插件</a></p>
<p> IK分词器地址 ： <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/usr/</span>share/elasticsearch</span><br><span class="line"></span><br><span class="line">.<span class="regexp">/bin/</span>elasticsearch-plugin install <span class="string">https:</span><span class="comment">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.3.0/elasticsearch-analysis-ik-6.3.0.zip</span></span><br></pre></td></tr></table></figure>
<h4 id="ik-max-word-和-ik-smart-什么区别"><a href="#ik-max-word-和-ik-smart-什么区别" class="headerlink" title="ik_max_word 和 ik_smart 什么区别?"></a>ik_max_word 和 ik_smart 什么区别?</h4><blockquote>
<p>ik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合；</p>
<p>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”。</p>
</blockquote>
<h1 id="Head插件（Chrome插件）"><a href="#Head插件（Chrome插件）" class="headerlink" title="Head插件（Chrome插件）"></a>Head插件（Chrome插件）</h1><p><a href="https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm" target="_blank" rel="noopener">https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm</a></p>
<p><img src="https://note.youdao.com/yws/public/resource/89fd8107d2eb24f39dcb46930ab604ab/xmlnote/093D56EBF8A043579EC35967DB663D12/3564" alt="image"></p>
<h1 id="创建文章索引"><a href="#创建文章索引" class="headerlink" title="创建文章索引"></a>创建文章索引</h1><h3 id="文章结构"><a href="#文章结构" class="headerlink" title="文章结构"></a>文章结构</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">10000</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"http://www......"</span>,</span><br><span class="line">    <span class="attr">"site"</span>: <span class="string">"site name"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"a notice title"</span>,</span><br><span class="line">    <span class="attr">"content"</span>: <span class="string">"a notice content .............. very large"</span>,</span><br><span class="line">    <span class="attr">"publishTime"</span>: <span class="string">"2018-06-01 00:00:00"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入关键字，搜索title和content两个字段，按PublishTime倒序排列。</p>
<p>字段用中文分词。</p>
<p>操作步骤参考<br><a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">IK中文分词器</a></p>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>索引名称<code>article</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">http:</span><span class="comment">//localhost:9200/article</span></span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"acknowledged"</span>:<span class="literal">true</span>,<span class="attr">"shards_acknowledged"</span>:<span class="literal">true</span>,<span class="attr">"index"</span>:<span class="string">"article"</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><p>映射名称 <code>policy</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http:<span class="regexp">//</span>localhost:<span class="number">9200</span><span class="regexp">/article/</span>policy<span class="regexp">/_mapping -H 'Content-Type:application/</span>json<span class="string">' -d'</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"properties"</span>: &#123;</span><br><span class="line">        <span class="string">"content"</span>: &#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="string">"search_analyzer"</span>: <span class="string">"ik_max_word"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"title"</span>: &#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="string">"search_analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="string">"fields"</span>: &#123;</span><br><span class="line">                <span class="string">"raw"</span>: &#123;</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">                    <span class="string">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"id"</span>:&#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"url"</span>:&#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"site"</span>:&#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="string">"search_analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="string">"fields"</span>: &#123;</span><br><span class="line">                <span class="string">"raw"</span>: &#123;</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">                    <span class="string">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"publishTime"</span>:&#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">            <span class="string">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"acknowledged"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看索引信息"><a href="#查看索引信息" class="headerlink" title="查看索引信息"></a>查看索引信息</h3><p><code>curl http://localhost:9200/_mapping?pretty=true</code></p>
<p>输出:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"article"</span> : &#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"policy"</span> : &#123;</span><br><span class="line">        <span class="attr">"properties"</span> : &#123;</span><br><span class="line">          <span class="attr">"content"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"id"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"long"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"publishTime"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"date"</span>,</span><br><span class="line">            <span class="attr">"format"</span> : <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"site"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"raw"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"title"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"raw"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"analyzer"</span> : <span class="string">"ik_max_word"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"url"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="增加数据"><a href="#增加数据" class="headerlink" title="增加数据"></a>增加数据</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http:<span class="regexp">//localhost:9200/article/policy/1 -H 'Content-Type:application/json' -d'</span></span><br><span class="line"><span class="regexp">&#123;</span></span><br><span class="line"><span class="regexp">    "id": 100,</span></span><br><span class="line"><span class="regexp">    "url": "http://</span>www.mofcom.gov.cn/article/b/c/<span class="number">201806</span>/<span class="number">20180602755321.shtml</span><span class="string">",</span></span><br><span class="line"><span class="string">    "</span>site<span class="string">": "</span>商务部<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>title<span class="string">": "</span>商务部公告<span class="number">2018</span>年第<span class="number">47</span>号 关于艾德凡斯树脂和化学品责任有限公司继承霍尼韦尔树脂和化学品责任有限公司在锦纶<span class="number">6</span>切片反倾销措施和己内酰胺反倾销措施中所适用税率的公告<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>content<span class="string">": "</span>【发布单位】中华人民共和国商务部【发布文号】公告<span class="number">2018</span>年第<span class="number">47</span>号【发布日期】<span class="number">2018</span>-<span class="number">6</span>-<span class="number">8</span>【实施日期】<span class="number">2018</span>-<span class="number">6</span>-<span class="number">9</span><span class="string">\n\n</span>　　<span class="number">2010</span>年<span class="number">4</span>月<span class="number">21</span>日，中华人民共和国商务部（以下简称商务部）发布<span class="number">2010</span>年第<span class="number">15</span>号公告，决定对原产于美国、欧盟、俄罗斯和台湾地区的进口锦纶<span class="number">6</span>切片征收反倾销税。<span class="number">2016</span>年<span class="number">4</span>月<span class="number">21</span>日，商务部发布<span class="number">2016</span>年第<span class="number">4</span>号公告，决定维持该反倾销措施，为期<span class="number">5</span>年。其中，美国的霍尼韦尔树脂和化学品责任有限公司在该反倾销案中适用的反倾销税率为<span class="number">36.2</span>%，其他美国公司适用的反倾销税率为<span class="number">96.5</span>%。<span class="string">\n</span>　　<span class="number">2011</span>年<span class="number">10</span>月<span class="number">18</span>日，商务部发布<span class="number">2011</span>年第<span class="number">68</span>号公告，决定对原产于欧盟和美国的进口己内酰胺征收反倾销税。<span class="number">2017</span>年<span class="number">10</span>月<span class="number">21</span>日，商务部发布<span class="number">2017</span>年第<span class="number">53</span>号公告，决定维持该反倾销措施，为期<span class="number">5</span>年。其中，美国的霍尼韦尔树脂和化学品责任有限公司在该反倾销案中适用的反倾销税率为<span class="number">3.6</span>%，其他美国公司适用的反倾销税率为<span class="number">24.2</span>%。<span class="string">\n</span>　　<span class="number">2017</span>年<span class="number">12</span>月<span class="number">27</span>日，美国的艾德凡斯树脂和化学品责任有限公司向商务部提交申请，称为了上市，霍尼韦尔树脂和化学品责任有限公司的名称已经变更为艾德凡斯树脂和化学品责任有限公司，请求由变更后的公司继承原公司在锦纶<span class="number">6</span>　切片反倾销措施、己内酰胺反倾销措施中所适用的反倾销税率，并提交了股东决议、更名前后的公司章程、注册文件、管理人员情况、生产能力、原材料供应商和销售客户信息，中华人民共和国驻美国大使馆的认证文件等相关证明材料。<span class="string">\n</span>　　商务部就上述申请事宜分别通知了中国大陆锦纶<span class="number">6</span>切片产业和己内酰胺产业。在规定时间内，相关产业未提出异议。<span class="string">\n</span>　　经审查，商务部认为，现有证据材料表明，霍尼韦尔树脂和化学品责任有限公司名称变更符合其相关法律规定，公司名称变更前后关于锦纶<span class="number">6</span>切片、己内酰胺的经营管理、生产能力、供应商关系和客户基础等均未发生变化。<span class="string">\n</span>　　据此，商务部决定：<span class="string">\n</span>　　一、由艾德凡斯树脂和化学品责任有限公司（AdvanSix Resins &amp; Chemicals LLC）继承霍尼韦尔树脂和化学品责任有限公司（Honeywell Resins &amp; Chemicals LLC）在锦纶<span class="number">6</span>切片反倾销措施中所适用的<span class="number">36.2</span>%的反倾销税率及其他权利义务。以霍尼韦尔树脂和化学品责任有限公司（HoneywellResins &amp;amp; Chemicals LLC）名称向中国大陆出口的锦纶<span class="number">6</span>切片产品，适用锦纶<span class="number">6</span>切片反倾销措施中其他美国公司<span class="number">96.5</span>%的反倾销税率。<span class="string">\n</span>　　二、由艾德凡斯树脂和化学品责任有限公司（AdvanSix Resins &amp; Chemicals LLC）继承霍尼韦尔树脂和化学品责任有限公司（Honeywell Resins &amp; Chemicals LLC）在己内酰胺反倾销措施中所适用的<span class="number">3.6</span>%的反倾销税率及其他权利义务。以霍尼韦尔树脂和化学品责任有限公司（HoneywellResins &amp; Chemicals LLC）名称向中国大陆出口的己内酰胺产品，适用己内酰胺反倾销措施中其他美国公司<span class="number">24.2</span>%的反倾销税率。<span class="string">\n</span>　　本公告自<span class="number">2018</span>年<span class="number">6</span>月<span class="number">9</span>日起执行。<span class="string">\n商</span> 务 部<span class="number">2018</span>年<span class="number">6</span>月<span class="number">8</span>日<span class="string">\n</span> <span class="string">\n",</span></span><br><span class="line">    <span class="string">"publishTime"</span>: <span class="string">"2018-06-08 09:22:41"</span></span><br><span class="line">&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"_index"</span>:<span class="string">"article"</span>,<span class="attr">"_type"</span>:<span class="string">"policy"</span>,<span class="attr">"_id"</span>:<span class="string">"1"</span>,<span class="attr">"_version"</span>:<span class="number">1</span>,<span class="attr">"result"</span>:<span class="string">"created"</span>,<span class="attr">"_shards"</span>:&#123;<span class="attr">"total"</span>:<span class="number">2</span>,<span class="attr">"successful"</span>:<span class="number">1</span>,<span class="attr">"failed"</span>:<span class="number">0</span>&#125;,<span class="attr">"_seq_no"</span>:<span class="number">0</span>,<span class="attr">"_primary_term"</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看数据记录"><a href="#查看数据记录" class="headerlink" title="查看数据记录"></a>查看数据记录</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http:<span class="regexp">//</span>localhost:<span class="number">9200</span><span class="regexp">/article/</span>policy<span class="regexp">/1</span></span><br></pre></td></tr></table></figure>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http:<span class="regexp">//</span>localhost:<span class="number">9200</span><span class="regexp">/article/</span>policy<span class="regexp">/_search  -H 'Content-Type:application/</span>json<span class="string">' -d'</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span> : &#123; <span class="string">"match"</span> : &#123; <span class="string">"content"</span> : <span class="string">"反倾销"</span>&#125;&#125;,</span><br><span class="line">    <span class="string">"highlight"</span> : &#123;</span><br><span class="line">        <span class="string">"pre_tags"</span> : [<span class="string">"&lt;tag1&gt;"</span>, <span class="string">"&lt;tag2&gt;"</span>],</span><br><span class="line">        <span class="string">"post_tags"</span> : [<span class="string">"&lt;/tag1&gt;"</span>, <span class="string">"&lt;/tag2&gt;"</span>],</span><br><span class="line">        <span class="string">"fields"</span> : &#123;</span><br><span class="line">            <span class="string">"content"</span> : &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>:<span class="number">10</span>,</span><br><span class="line">   <span class="attr">"timed_out"</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"_shards"</span>:&#123;</span><br><span class="line">      <span class="attr">"total"</span>:<span class="number">5</span>,</span><br><span class="line">      <span class="attr">"successful"</span>:<span class="number">5</span>,</span><br><span class="line">      <span class="attr">"skipped"</span>:<span class="number">0</span>,</span><br><span class="line">      <span class="attr">"failed"</span>:<span class="number">0</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"hits"</span>:&#123;</span><br><span class="line">      <span class="attr">"total"</span>:<span class="number">1</span>,</span><br><span class="line">      <span class="attr">"max_score"</span>:<span class="number">1.1982318</span>,</span><br><span class="line">      <span class="attr">"hits"</span>:[</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"_index"</span>:<span class="string">"article"</span>,</span><br><span class="line">            <span class="attr">"_type"</span>:<span class="string">"policy"</span>,</span><br><span class="line">            <span class="attr">"_id"</span>:<span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"_score"</span>:<span class="number">1.1982318</span>,</span><br><span class="line">            <span class="attr">"_source"</span>:&#123;</span><br><span class="line">               <span class="attr">"id"</span>:<span class="number">100</span>,</span><br><span class="line">               <span class="attr">"url"</span>:<span class="string">"http://www.mofcom.gov.cn/article/b/c/201806/20180602755321.shtml"</span>,</span><br><span class="line">               <span class="attr">"site"</span>:<span class="string">"商务部"</span>,</span><br><span class="line">               <span class="attr">"title"</span>:<span class="string">"商务部公告2018年第47号 关于艾德凡斯树脂和化学品责任有限公司继承霍尼韦尔树脂和化学品责任有限公司在锦纶6切片反倾销措施和己内酰胺反倾销措施中所适用税率的公告"</span>,</span><br><span class="line">               <span class="attr">"content"</span>:<span class="string">"【发布单位】中华人民共和国商务部【发布文号】公告2018年第47号【发布日期】2018-6-8【实施日期】2018-6-9\n\n　　2010年4月21日，中华人民共和国商务部（以下简称商务部）发布2010年第15号公告，决定对原产于美国、欧盟、俄罗斯和台湾地区的进口锦纶6切片征收反倾销税。2016年4月21日，商务部发布2016年第4号公告，决定维持该反倾销措施，为期5年。其中，美国的霍尼韦尔树脂和化学品责任有限公司在该反倾销案中适用的反倾销税率为36.2%，其他美国公司适用的反倾销税率为96.5%。\n　　2011年10月18日，商务部发布2011年第68号公告，决定对原产于欧盟和美国的进口己内酰胺征收反倾销税。2017年10月21日，商务部发布2017年第53号公告，决定维持该反倾销措施，为期5年。其中，美国的霍尼韦尔树脂和化学品责任有限公司在该反倾销案中适用的反倾销税率为3.6%，其他美国公司适用的反倾销税率为24.2%。\n　　2017年12月27日，美国的艾德凡斯树脂和化学品责任有限公司向商务部提交申请，称为了上市，霍尼韦尔树脂和化学品责任有限公司的名称已经变更为艾德凡斯树脂和化学品责任有限公司，请求由变更后的公司继承原公司在锦纶6　切片反倾销措施、己内酰胺反倾销措施中所适用的反倾销税率，并提交了股东决议、更名前后的公司章程、注册文件、管理人员情况、生产能力、原材料供应商和销售客户信息，中华人民共和国驻美国大使馆的认证文件等相关证明材料。\n　　商务部就上述申请事宜分别通知了中国大陆锦纶6切片产业和己内酰胺产业。在规定时间内，相关产业未提出异议。\n　　经审查，商务部认为，现有证据材料表明，霍尼韦尔树脂和化学品责任有限公司名称变更符合其相关法律规定，公司名称变更前后关于锦纶6切片、己内酰胺的经营管理、生产能力、供应商关系和客户基础等均未发生变化。\n　　据此，商务部决定：\n　　一、由艾德凡斯树脂和化学品责任有限公司（AdvanSix Resins &amp; Chemicals LLC）继承霍尼韦尔树脂和化学品责任有限公司（Honeywell Resins &amp; Chemicals LLC）在锦纶6切片反倾销措施中所适用的36.2%的反倾销税率及其他权利义务。以霍尼韦尔树脂和化学品责任有限公司（HoneywellResins &amp;amp; Chemicals LLC）名称向中国大陆出口的锦纶6切片产品，适用锦纶6切片反倾销措施中其他美国公司96.5%的反倾销税率。\n　　二、由艾德凡斯树脂和化学品责任有限公司（AdvanSix Resins &amp; Chemicals LLC）继承霍尼韦尔树脂和化学品责任有限公司（Honeywell Resins &amp; Chemicals LLC）在己内酰胺反倾销措施中所适用的3.6%的反倾销税率及其他权利义务。以霍尼韦尔树脂和化学品责任有限公司（HoneywellResins &amp; Chemicals LLC）名称向中国大陆出口的己内酰胺产品，适用己内酰胺反倾销措施中其他美国公司24.2%的反倾销税率。\n　　本公告自2018年6月9日起执行。\n商 务 部2018年6月8日\n \n"</span>,</span><br><span class="line">               <span class="attr">"publishTime"</span>:<span class="string">"2018-06-08 09:22:41"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"highlight"</span>:&#123;</span><br><span class="line">               <span class="attr">"content"</span>:[</span><br><span class="line">                  <span class="string">"其中，美国的霍尼韦尔树脂和化学品责任有限公司在该&lt;tag1&gt;反倾销&lt;/tag1&gt;案中适用的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率为36.2%，其他美国公司适用的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率为96.5%。\n　　"</span>,</span><br><span class="line">                  <span class="string">"2011年10月18日，商务部发布2011年第68号公告，决定对原产于欧盟和美国的进口己内酰胺征收&lt;tag1&gt;反倾销&lt;/tag1&gt;税。2017年10月21日，商务部发布2017年第53号公告，决定维持该&lt;tag1&gt;反倾销&lt;/tag1&gt;措施，为期5年。"</span>,</span><br><span class="line">                  <span class="string">"其中，美国的霍尼韦尔树脂和化学品责任有限公司在该&lt;tag1&gt;反倾销&lt;/tag1&gt;案中适用的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率为3.6%，其他美国公司适用的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率为24.2%。\n　　"</span>,</span><br><span class="line">                  <span class="string">"36.2%的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率及其他权利义务。"</span>,</span><br><span class="line">                  <span class="string">"3.6%的&lt;tag1&gt;反倾销&lt;/tag1&gt;税率及其他权利义务。"</span></span><br><span class="line">               ]</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在Java程序中使用ElasticSearch"><a href="#在Java程序中使用ElasticSearch" class="headerlink" title="在Java程序中使用ElasticSearch"></a>在Java程序中使用ElasticSearch</h2><p>SpringBoot应用中可以使用Spring-data-ElasticSearch来进行操作</p>
<p><a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/" target="_blank" rel="noopener">https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/</a></p>
<p><a href="https://github.com/spring-projects/spring-data-elasticsearch" target="_blank" rel="noopener">https://github.com/spring-projects/spring-data-elasticsearch</a></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>如下配置为JHipster中的默认配置</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p><code>build.gradle</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"org.springframework.boot:spring-boot-starter-data-elasticsearch"</span></span><br><span class="line"><span class="regexp">//</span> needed to get around elasticsearch stacktrace about jna not found</span><br><span class="line"><span class="regexp">//</span> https:<span class="regexp">//gi</span>thub.com<span class="regexp">/elastic/</span>elasticsearch<span class="regexp">/issues/</span><span class="number">13245</span></span><br><span class="line">compile <span class="string">"net.java.dev.jna:jna"</span></span><br></pre></td></tr></table></figure>
<h4 id="Java-Configuration"><a href="#Java-Configuration" class="headerlink" title="Java Configuration"></a>Java Configuration</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.policy.collection.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Client;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.<span class="keyword">data</span>.elasticsearch.ElasticsearchProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.elasticsearch.core.ElasticsearchTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.elasticsearch.core.EntityMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.Jackson2ObjectMapperBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ElasticsearchProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(<span class="meta-string">"spring.data.elasticsearch.cluster-nodes"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ElasticsearchTemplate elasticsearchTemplate(Client client, Jackson2ObjectMapperBuilder jackson2ObjectMapperBuilder) &#123;</span><br><span class="line">        <span class="keyword">return</span> new ElasticsearchTemplate(client, new CustomEntityMapper(jackson2ObjectMapperBuilder.createXmlMapper(<span class="literal">false</span>).build()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEntityMapper</span> <span class="title">implements</span> <span class="title">EntityMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> CustomEntityMapper(ObjectMapper objectMapper) &#123;</span><br><span class="line">            <span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">            objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br><span class="line">            objectMapper.configure(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String mapToString(Object <span class="keyword">object</span>) throws IOException &#123;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.writeValueAsString(<span class="keyword">object</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T mapToObject(String source, Class&lt;T&gt; clazz) throws IOException &#123;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readValue(source, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>appplication.yml</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spring</span>:</span><br><span class="line">    <span class="attribute">data</span>:</span><br><span class="line">        <span class="attribute">elasticsearch</span>:</span><br><span class="line">            <span class="attribute">cluster-name</span>: elastic</span><br><span class="line">            <span class="attribute">cluster-nodes</span>: <span class="attribute">localhost</span>:<span class="number">9300</span></span><br></pre></td></tr></table></figure>
<h4 id="创建ElasticsearchRepository接口"><a href="#创建ElasticsearchRepository接口" class="headerlink" title="创建ElasticsearchRepository接口"></a>创建ElasticsearchRepository接口</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.policy.collection.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.elasticsearch.annotations.Document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(indexName = <span class="meta-string">"article"</span>, type = <span class="meta-string">"policy"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PolicyArticle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String site;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> ZonedDateTime publishTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.policy</span><span class="selector-class">.collection</span><span class="selector-class">.repository</span><span class="selector-class">.search</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.policy</span><span class="selector-class">.collection</span><span class="selector-class">.dto</span><span class="selector-class">.PolicyArticle</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.data</span><span class="selector-class">.elasticsearch</span><span class="selector-class">.repository</span><span class="selector-class">.ElasticsearchRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Spring Data Elasticsearch repository for the PolicyArticle entity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">PolicyArticleSearchRepository</span> <span class="selector-tag">extends</span> <span class="selector-tag">ElasticsearchRepository</span>&lt;<span class="selector-tag">PolicyArticle</span>, <span class="selector-tag">Long</span>&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>ElasticsearchRepository</code>具有如下搜索方法，并且它继承了CRUD功能。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoRepositoryBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">ElasticsearchCrudRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    &lt;S extends T&gt; <span class="function">S <span class="title">index</span><span class="params">(S entity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;T&gt; <span class="title">search</span><span class="params">(QueryBuilder query)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">search</span><span class="params">(QueryBuilder query, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">search</span><span class="params">(SearchQuery searchQuery)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">searchSimilar</span><span class="params">(T entity, String[] fields, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getEntityClass</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="增加和更新数据"><a href="#增加和更新数据" class="headerlink" title="增加和更新数据"></a>增加和更新数据</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.policy.collection.repository.search;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.TestBase;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.domain.ContentPage;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.dto.PolicyArticle;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.repository.ContentPageRepository;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.repository.PageSourceRepository;</span><br><span class="line"><span class="keyword">import</span> com.policy.collection.utils.DateUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PolicyArticleSearchRepositoryTest</span> <span class="title">extends</span> <span class="title">TestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">PolicyArticleSearchRepository</span> searchRepository;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ContentPageRepository</span> contentPageRepository;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">PageSourceRepository</span> pageSourceRepository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @<span class="type">Test</span></span><br><span class="line">    <span class="keyword">public</span> void addData() &#123;</span><br><span class="line">        int pageNo = <span class="number">0</span>;</span><br><span class="line">        int pageSize = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Page</span>&lt;<span class="type">ContentPage</span>&gt; page = contentPageRepository.findAll(<span class="type">PageRequest</span>.of(pageNo, pageSize, <span class="type">Sort</span>.<span class="type">Direction</span>.<span class="type">ASC</span>, <span class="string">"id"</span>));</span><br><span class="line">            <span class="type">List</span>&lt;<span class="type">ContentPage</span>&gt; list = page.getContent();</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">CollectionUtils</span>.isEmpty(list)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pageNo++;</span><br><span class="line"></span><br><span class="line">            <span class="type">List</span>&lt;<span class="type">PolicyArticle</span>&gt; policyArticles = <span class="type">Lists</span>.newArrayList();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">ContentPage</span> contentPage : list) &#123;</span><br><span class="line">                <span class="type">PolicyArticle</span> article = new <span class="type">PolicyArticle</span>();</span><br><span class="line">                article.setId(contentPage.getId());</span><br><span class="line">                article.setUrl(contentPage.getUrl());</span><br><span class="line">                article.setTitle(contentPage.getTitle());</span><br><span class="line">                article.setContent(contentPage.getTextContent());</span><br><span class="line">                <span class="type">String</span> publishTime = <span class="type">DateUtil</span>.format(contentPage.getPublishTime());</span><br><span class="line">                <span class="keyword">if</span>(<span class="type">StringUtils</span>.isNotBlank(publishTime)) &#123;</span><br><span class="line">                    article.setPublishTime(publishTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Long</span> sourceId = contentPage.getSourceId();</span><br><span class="line">                pageSourceRepository.findById(sourceId).ifPresent(source -&gt; article.setSite(source.getSite()));</span><br><span class="line">                policyArticles.add(article);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            searchRepository.saveAll(policyArticles);</span><br><span class="line">            logger.info(<span class="string">"Save articles to es with size=&#123;&#125;"</span>, policyArticles.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">search</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryBuilder builder = <span class="keyword">new</span> QueryStringQueryBuilder(<span class="string">"content:反倾销"</span>);</span><br><span class="line">    Page&lt;PolicyArticle&gt; page = searchRepository.search(builder, PageRequest.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">    logger.info(<span class="string">"page=&#123;&#125;"</span>, page);</span><br><span class="line">    <span class="keyword">for</span> (PolicyArticle article : page) &#123;</span><br><span class="line">        logger.info(<span class="string">"article=&#123;&#125;"</span>, article);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/基础技术/">基础技术</a></div><div class="post-nav"><a class="pre" href="/site_search_6">6、个性化搜索</a><a class="next" href="/resume_analysis_1">简历分析设想</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.codeessay.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code-snippet/">代码片段</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/foundation/">基础技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/architecture/">架构设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">框架学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/基础技术-pandas/" style="font-size: 15px;">基础技术, pandas</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/架构设计/" style="font-size: 15px;">架构设计</a> <a href="/tags/基础技术-graph-db/" style="font-size: 15px;">基础技术, graph_db</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/JHipster-SpringMVC/" style="font-size: 15px;">JHipster, SpringMVC</a> <a href="/tags/Django-Python/" style="font-size: 15px;">Django, Python</a> <a href="/tags/基础技术-recommend/" style="font-size: 15px;">基础技术, recommend</a> <a href="/tags/基础技术-scrapy/" style="font-size: 15px;">基础技术, scrapy</a> <a href="/tags/基础技术/" style="font-size: 15px;">基础技术</a> <a href="/tags/基础技术-site-search/" style="font-size: 15px;">基础技术, site_search</a> <a href="/tags/基础技术-sklearn/" style="font-size: 15px;">基础技术, sklearn</a> <a href="/tags/基础技术-spark/" style="font-size: 15px;">基础技术, spark</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/recommend_1">1、推荐系统概述：策略，架构，数据，效果评估</a></li><li class="post-list-item"><a class="post-list-link" href="/scrapy_0">Scrapy爬虫框架</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_0">图数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_1">1、图数据库的基本概念和主流图数据库对比， 知识图谱</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_2">2、Neo4j的使用：安装， Cypher， 数据管理，导入导出， 前端Html，聚类</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_3">3、Neo4j的Java API</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_5">5、Gremlin的Java API</a></li><li class="post-list-item"><a class="post-list-link" href="/graph_db_6">6、D3展示图</a></li><li class="post-list-item"><a class="post-list-link" href="/sklearn_8">8、在Java程序中使用sklearn模型</a></li><li class="post-list-item"><a class="post-list-link" href="/sklearn_7">7、模型保存和载入，在线更新</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">技术随笔.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>